<!-- Importing base.html as template -->
{% extends 'website/base.html' %}
{% load staticfiles %}
{% load to_datetime %}
{% load duration %}
{% load mathfilters %}
<!-- Page Title -->
{% block title %} {{project.name}} {% endblock %}
<!-- Page Stylesheets -->
{% block css  %}
	<style type="text/css">
		.time_series{
			margin: 40px;
		}

		h4{
			font-weight: normal;
		}
	</style>
{% endblock  %}
{% block body %}
	<div class="container">
		<div class="row">
			<!-- Project main info -->
			<div class="col-lg-6">
				<h1 style="display: inline; text-decoration: none;">
					{{project.name | capfirst}}  
				</h1>
				<br>| Mostly written in {{project.main_language}}<br>
				{% include 'website/_badges.html' %}<br>
				<a href="{{project.github_url}}" target="_blank">Github offical repository</a> <span class="fab fa-github"></span><br>
				Data presented here was collected in 
				{{project.updated_at| to_datetime}}<br>
				Domain/Scope: <b>{{project.domain}}</b><br>
				Under <i>{{project.license}}</i>
			</div>
			<br>
			<!-- Statistics table -->
			<div class="col-lg-6">
			<h4>
				<span><img src="{% static 'resources/icons/png/021-diagnosis.png' %}" height="35px" width="35px" class="img-fluid"></span>
				Some statistics
			</h4>
			<table class="table">
			  <tbody>
			    <tr>
			      <th>Average newcomers per Year</th>
			      {% with year=project.created_at|duration %}
			      <td>{{project.statistics.newcomers_total|intdiv:year}}</td>
			      {% endwith %}
			    </tr>
			    <tr>
			      <th scope="row">Total Forks</th>
			      <td>{{project.statistics.forks_total}}</td>
			    </tr>
			    <tr>
			      <th scope="row">Total pull requests merged</th>
			      <td>{{project.statistics.pulls_merged_total}}</td>
			    </tr>
			    <tr>
			      <th scope="row">Contributors total</th>
			      <td>{{project.statistics.contributors_total}}</td>
			    </tr>    
			  </tbody>
			</table>
		</div>
		</div>
		
		<!-- Charts -->
		<h4>Newcomers Entrance</h4>
		<div class="time_series" id="{{project.project_id}}_newcomers_ts"></div>
		<h4>Forks</h4>
		<div class="time_series" id="{{project.project_id}}_forks_ts"></div>
		<h4>Merged Pulls</h4>
		<div class="time_series" id="{{project.project_id}}_pulls_merged_ts"></div>

	</div>
{% endblock %}

<!-- Google Charts script  -->
{% block javascript %}
	<script>
	google.charts.load('current', {'packages':['annotationchart']});
	google.charts.setOnLoadCallback(drawNewcomersTS);
	google.charts.load('current', {'packages':['line']});
	google.charts.setOnLoadCallback(drawForksTS);
	google.charts.setOnLoadCallback(drawPullsMergedTS);
		
	function drawNewcomersTS(){
		var data = new google.visualization.DataTable();
		data.addColumn('datetime', 'Date');
		data.addColumn('number', 'Newcomers');
 
		var rows = []
		{% for key, value in project.time_series.newcomers_ts.items %}
		rows.push([new Date("{{ key }}"), {{ value }}]);
		{% endfor %}
		rows.sort(function(a,b){return a[0].getTime() - b[0].getTime()})
		data.addRows(rows);
		
		var options = { fontName: 'Rajdhani',
						displayAnnotations: true,
						title:'Newcomers (Daily)',

						hAxis: {
					          title: 'Number of newcomers',
        				},
        				vAxis: {
          					title: 'Date'
        				},
						height:400,
						};

		var {{project.project_id}}_newcomers_ts = new google.visualization.AnnotationChart(document.getElementById('{{project.project_id}}_newcomers_ts'));		
		{{project.project_id}}_newcomers_ts.draw(data, options);
	};

	function drawForksTS(){
		var data = new google.visualization.DataTable();
		data.addColumn('datetime', 'Date');
		data.addColumn('number', '# Forks');

		var rows = []
		{% for key, value in project.time_series.forks_ts.items %}
		rows.push([new Date("{{ key }}"), {{ value }}]);
		{% endfor %}
		rows.sort(function(a,b){return a[0].getTime() - b[0].getTime()})
		data.addRows(rows);

		var result = google.visualization.data.group(
        data, [{
            'column': 0,
            'aggregation': google.visualization.data.month,
            'type': 'date'
        }],
        	  [{
            'column': 1,
            'aggregation': google.visualization.data.sum,
            'type': 'number'
        }]);
		
		var options = {fontName: 'Rajdhani', title:'Forks (Daily)', curveType: 'function'};
		var {{project.project_id}}_forks_ts = new google.charts.Line(document.getElementById('{{project.project_id}}_forks_ts'));		
		{{project.project_id}}_forks_ts.draw(result, options);
	};

	function drawPullsMergedTS(){
		var data = new google.visualization.DataTable();
		data.addColumn('datetime', 'Date');
		data.addColumn('number', '# Pulls Merged');

		var rows = []
		{% for key, value in project.time_series.pulls_merged_ts.items %}
		rows.push([new Date("{{ key }}"), {{ value }}]);
		{% endfor %}
		rows.sort(function(a,b){return a[0].getTime() - b[0].getTime()})
		data.addRows(rows);

		var data_aggregated_by_month = google.visualization.data.group(
        data, [{
            'column': 0,
            'aggregation': google.visualization.data.month,
            'type': 'date'
        }],
        	  [{
            'column': 1,
            'aggregation': google.visualization.data.sum,
            'type': 'number'
        }]);
		
		var options = {fontName: 'Rajdhani', title:'Pulls Merged (Daily)', curveType: 'function'};
		var {{project.project_id}}_pulls_merged_ts = new google.charts.Line(document.getElementById('{{project.project_id}}_pulls_merged_ts'));		
		{{project.project_id}}_pulls_merged_ts.draw(data_aggregated_by_month, options);
	};

	</script>
{% endblock %}
